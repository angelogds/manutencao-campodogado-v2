<% layout('layout') %>

<style>
  .card{ background:#fff; border:1px solid #e5e7eb; border-radius:16px; padding:16px; box-shadow:0 10px 26px rgba(0,0,0,.06); }
  .grid{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  .row{ display:flex; gap:10px; align-items:end; flex-wrap:wrap; }
  .input, textarea, select{ width:100%; padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; }
  label{ font-size:12px; font-weight:900; color:#374151; }
  .btn{ display:inline-block; padding:10px 12px; border-radius:12px; border:1px solid #e5e7eb; background:#fff; text-decoration:none; font-weight:900; color:#111827; cursor:pointer; }
  .btn.primary{ background:#0b6b3a; border-color:#0b6b3a; color:#fff; }
  .table{ width:100%; border-collapse:separate; border-spacing:0; margin-top:12px; border:1px solid #e5e7eb; border-radius:16px; overflow:hidden; }
  .table th,.table td{ padding:10px 10px; border-bottom:1px solid #f1f5f9; text-align:left; font-size:14px; }
  .table th{ font-size:12px; color:#6b7280; text-transform:uppercase; letter-spacing:.04em; }
  .muted{ color:#6b7280; }
  @media(max-width:900px){ .grid{ grid-template-columns:1fr; } }
</style>

<h1 style="margin-top:0;">Nova Solicitação</h1>
<p class="muted" style="margin-top:-6px;">Crie uma solicitação com itens. Isso vira fila do setor de Compras.</p>

<form method="POST" action="/compras">
  <div class="card">
    <div class="grid">
      <div>
        <label>Título</label>
        <input class="input" name="titulo" required placeholder="Ex: Correias Prensa P50/P46" />
      </div>

      <div>
        <label>Setor</label>
        <input class="input" name="setor" required placeholder="Manutenção" />
      </div>

      <div>
        <label>Prioridade</label>
        <select name="prioridade" class="input">
          <option value="BAIXA">BAIXA</option>
          <option value="NORMAL" selected>NORMAL</option>
          <option value="ALTA">ALTA</option>
          <option value="URGENTE">URGENTE</option>
        </select>
      </div>

      <div>
        <label>Descrição (resumo)</label>
        <input class="input" name="descricao" required placeholder="Ex: Compra de correias para substituição programada" />
      </div>
    </div>

    <hr style="border:none; border-top:1px solid #eef2f7; margin:14px 0;" />

    <div class="row">
      <div style="min-width:240px; flex:2;">
        <label>Item (descrição)</label>
        <input class="input" id="i_desc" placeholder="Ex: Correia B102" />
      </div>
      <div style="min-width:110px;">
        <label>Unidade</label>
        <input class="input" id="i_un" value="UN" />
      </div>
      <div style="min-width:110px;">
        <label>Quantidade</label>
        <input class="input" id="i_qtd" type="number" step="0.01" value="1" />
      </div>
      <div style="min-width:240px; flex:2;">
        <label>Observação</label>
        <input class="input" id="i_obs" placeholder="Ex: Prensa P50 e P46" />
      </div>

      <button class="btn" type="button" onclick="addItem()">+ Adicionar</button>
    </div>

    <table class="table" id="itemsTable">
      <thead>
        <tr>
          <th>Descrição</th>
          <th style="width:120px;">Un</th>
          <th style="width:140px;">Qtd</th>
          <th>Obs</th>
          <th style="width:90px;"></th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="5" class="muted">Adicione itens acima.</td></tr>
      </tbody>
    </table>

    <div style="display:flex; gap:10px; justify-content:flex-end; margin-top:14px;">
      <a class="btn" href="/compras">Cancelar</a>
      <button class="btn primary" type="submit">Enviar Solicitação</button>
    </div>
  </div>
</form>

<script>
  const tbody = document.querySelector("#itemsTable tbody");

  function addItem(){
    const d = document.getElementById("i_desc").value.trim();
    const u = document.getElementById("i_un").value.trim() || "UN";
    const q = Number(document.getElementById("i_qtd").value || 0);
    const o = document.getElementById("i_obs").value.trim();

    if(!d || q <= 0){
      alert("Informe descrição e quantidade > 0");
      return;
    }

    // limpa placeholder
    if(tbody.children.length === 1 && tbody.children[0].children.length === 1){
      tbody.innerHTML = "";
    }

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>
        ${escapeHtml(d)}
        <input type="hidden" name="item_descricao" value="${escapeAttr(d)}" />
      </td>
      <td>
        ${escapeHtml(u)}
        <input type="hidden" name="item_unidade" value="${escapeAttr(u)}" />
      </td>
      <td>
        ${q}
        <input type="hidden" name="item_quantidade" value="${q}" />
      </td>
      <td>
        ${escapeHtml(o)}
        <input type="hidden" name="item_observacao" value="${escapeAttr(o)}" />
      </td>
      <td>
        <button class="btn" type="button" onclick="this.closest('tr').remove(); fixEmpty()">Remover</button>
      </td>
    `;
    tbody.appendChild(tr);

    document.getElementById("i_desc").value = "";
    document.getElementById("i_obs").value = "";
    document.getElementById("i_qtd").value = "1";
    document.getElementById("i_desc").focus();
  }

  function fixEmpty(){
    if(tbody.children.length === 0){
      tbody.innerHTML = '<tr><td colspan="5" class="muted">Adicione itens acima.</td></tr>';
    }
  }

  function escapeHtml(s){
    return (s||"").replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
  }
  function escapeAttr(s){ return escapeHtml(s); }
</script>
